{% extends "base.html" %}

{% block title %}Home - Flashcard App{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Your Decks</h1>
    <a href="{{ url_for('import_deck') }}" class="btn btn-primary">+ Import Deck</a>
</div>

{% if deck_stats %}
    <div class="deck-grid">
        {% macro render_node(node) %}
            <div class="deck-card">
                <div class="deck-card-header">
                    <h2>
                        <span class="deck-name-display" id="deck-name-{{ node.deck.id }}">{{ node.deck.name }}</span>
                        <input type="text" 
                               class="deck-name-input" 
                               id="deck-input-{{ node.deck.id }}" 
                               value="{{ node.deck.name }}" 
                               style="display: none;"
                               maxlength="200">
                        <button class="deck-edit-btn" 
                                id="edit-btn-{{ node.deck.id }}"
                                onclick="enableDeckEdit({{ node.deck.id }})"
                                title="Rename deck">‚úèÔ∏è</button>
                        <button class="deck-save-btn" 
                                id="save-btn-{{ node.deck.id }}"
                                onclick="saveDeckName({{ node.deck.id }})"
                                style="display: none;"
                                title="Save">üíæ</button>
                        <button class="deck-cancel-btn" 
                                id="cancel-btn-{{ node.deck.id }}"
                                onclick="cancelDeckEdit({{ node.deck.id }})"
                                style="display: none;"
                                title="Cancel">‚úñÔ∏è</button>
                    </h2>
                    {% if node.due > 0 %}
                        <span class="badge badge-primary">{{ node.due }} due</span>
                    {% endif %}
                </div>
                
                {% if node.deck.description %}
                    <p class="deck-description">{{ node.deck.description }}</p>
                {% endif %}
                
                <div class="deck-stats">
                    <div class="stat">
                        <span class="stat-label">Total</span>
                        <span class="stat-value">{{ node.stats.total }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">New</span>
                        <span class="stat-value stat-new">{{ node.stats.new }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Learning</span>
                        <span class="stat-value stat-learning">{{ node.stats.learning }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Review</span>
                        <span class="stat-value stat-review">{{ node.stats.review }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Mastered</span>
                        <span class="stat-value stat-mastered">{{ node.stats.mastered }}</span>
                    </div>
                </div>
                
                <div class="deck-actions">
                    {% if node.due > 0 %}
                        <a href="{{ url_for('study', deck_id=node.deck.id) }}" class="btn btn-primary">Study Now</a>
                    {% else %}
                        <a href="{{ url_for('deck_detail', deck_id=node.deck.id) }}" class="btn btn-secondary">View Details</a>
                    {% endif %}
                    <button class="btn btn-secondary btn-sm" onclick="createSubdeck({{ node.deck.id }})">+ Subdeck</button>
                    <form method="POST" action="{{ url_for('delete_deck', deck_id=node.deck.id) }}" 
                          style="display: inline;"
                          onsubmit="return confirm('Are you sure you want to delete this deck?');">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </div>
                
                <div class="deck-meta">
                    Created {{ node.deck.created_at|timeago }}
                </div>

                {% if node.children %}
                    <div class="deck-children">
                        {% for child in node.children %}
                            {{ render_node(child) }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endmacro %}

        {% for node in deck_stats %}
            {{ render_node(node) }}
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-icon">üìö</div>
        <h2>No decks yet</h2>
        <p>Import your first deck to get started with spaced repetition learning!</p>
        <a href="{{ url_for('import_deck') }}" class="btn btn-primary">Import a Deck</a>
    </div>
{% endif %}

<script>
function enableDeckEdit(deckId) {
    const nameDisplay = document.getElementById(`deck-name-${deckId}`);
    const nameInput = document.getElementById(`deck-input-${deckId}`);
    const editBtn = document.getElementById(`edit-btn-${deckId}`);
    const saveBtn = document.getElementById(`save-btn-${deckId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${deckId}`);
    
    nameDisplay.style.display = 'none';
    editBtn.style.display = 'none';
    nameInput.style.display = 'inline-block';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    nameInput.focus();
    nameInput.select();
    
    // Save on Enter, cancel on Escape
    nameInput.onkeydown = function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveDeckName(deckId);
        } else if (e.key === 'Escape') {
            cancelDeckEdit(deckId);
        }
    };
}

function cancelDeckEdit(deckId) {
    const nameDisplay = document.getElementById(`deck-name-${deckId}`);
    const nameInput = document.getElementById(`deck-input-${deckId}`);
    const editBtn = document.getElementById(`edit-btn-${deckId}`);
    const saveBtn = document.getElementById(`save-btn-${deckId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${deckId}`);
    
    // Reset to original value
    nameInput.value = nameDisplay.textContent;
    
    nameDisplay.style.display = 'inline';
    editBtn.style.display = 'inline-block';
    nameInput.style.display = 'none';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

function saveDeckName(deckId) {
    const nameDisplay = document.getElementById(`deck-name-${deckId}`);
    const nameInput = document.getElementById(`deck-input-${deckId}`);
    const newName = nameInput.value.trim();
    
    if (!newName) {
        alert('Deck name cannot be empty');
        nameInput.focus();
        return;
    }
    
    if (newName === nameDisplay.textContent) {
        cancelDeckEdit(deckId);
        return;
    }
    
    // Save via API
    fetch(`/api/deck/${deckId}/rename`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nameDisplay.textContent = newName;
            cancelDeckEdit(deckId);
        } else {
            alert(data.error || 'Failed to rename deck');
            nameInput.focus();
        }
    })
    .catch(error => {
        alert('Error renaming deck: ' + error);
        nameInput.focus();
    });
}

function createSubdeck(parentId) {
    const name = prompt('Enter name for the new subdeck:');
    if (!name) return;

    fetch('/api/deck', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name.trim(), parent_id: parentId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Reload to show new subdeck for simplicity
            location.reload();
        } else {
            alert(data.error || 'Could not create subdeck');
        }
    })
    .catch(err => alert('Error: ' + err));
}
</script>
{% endblock %}
